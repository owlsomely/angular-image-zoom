/*! angular-image-zoom - v0.1.0 - Chen Liang MIT - 2014-12-27 */"use strict";var ImageZoom=angular.module("ImageZoom",[]).constant("ImageZoomDefaultConfig",{templateUrl:"image-zoom.html",zoomFactor:1.5,backgroundColor:"transparent"}).controller("ImageZoomController",["$scope",function($scope){$scope.imgSrc="",$scope.zoomImgSrc=""}]).directive("imageZoom",["ImageZoomDefaultConfig","$document",function(ImageZoomDefaultConfig,$document){return{restrict:"EA",replace:!0,templateUrl:function(tElement,tAttrs){return tAttrs.templateUrl||ImageZoomDefaultConfig.templateUrl},scope:{imageSrc:"@",zoomFactor:"=?",maxHeight:"=?",maxWidth:"=?",positionAbsolute:"=?",backgroundColor:"=?",templateUrl:"=?templateUrl"},link:function($scope,element){var el,nWidth,nHeight,lensCSS,lens=element.find("div"),image=element.find("img"),isLensHidden=!1,isImageLoading=!1;$scope.zoomFactor||($scope.zoomFactor=ImageZoomDefaultConfig.zoomFactor),$scope.backgroundColor||($scope.backgroundColor=ImageZoomDefaultConfig.backgroundColor);var watchImageSrc=$scope.$parent.$watch("imageSrc",function(newVale){newVale&&($scope.imageSrc=newVale)});if(!("ontouchstart"in window||window.DocumentTouch&&document instanceof DocumentTouch)){var hideLens=function(){lens.css({opacity:0,filter:"alpha(opacity=0)",display:"none"}),isLensHidden=!0},showGlass=function(){lens.css({display:"block",opacity:1,filter:"alpha(opacity=100)"})},changeLensBgImg=function(img){lens.css({background:$scope.backgroundColor+" url("+img+") no-repeat","background-size":nWidth*$scope.zoomFactor+"px "+nHeight*$scope.zoomFactor+"px"})},mousemove=function(evt){lensCSS=$scope.magnify(evt),lensCSS&&lens.css(lensCSS)},mouseleave=function(){hideLens(),$document.off("mousemove",mousemove),$document.off("mouseleave",mouseleave)};element.on("mouseenter",function(){isLensHidden&&showGlass();var extInfo={width:element[0].offsetWidth,height:element[0].offsetHeight,imageWidth:image[0].offsetWidth,imageHeight:image[0].offsetHeight,lensWidth:lens[0].offsetWidth,lensHeight:lens[0].offsetHeight};el=angular.extend($scope.getOffset(element[0]),extInfo),$document.on("mousemove",mousemove),$document.on("mouseleave",mouseleave)}),element.on("destroy",watchImageSrc),image.bind("load",function(){nWidth=this.naturalWidth,nHeight=this.naturalHeight,changeLensBgImg($scope.imageSrc),($scope.maxHeight||$scope.maxWidth)&&ensureAspectRatio(nWidth,nHeight)});var ensureAspectRatio=function(nWidth,nHeight){var maxWidth=image.width||$scope.maxWidth,maxHeight=image.height||$scope.maxHeight,newSize=calculateAspectRatioFit(nWidth,nHeight,maxWidth,maxHeight);element.css({width:newSize.width+"px",height:newSize.height+"px"})},calculateAspectRatioFit=function(srcWidth,srcHeight,maxWidth,maxHeight){var ratio=Math.min(maxWidth/srcWidth,maxHeight/srcHeight);return{width:srcWidth*ratio,height:srcHeight*ratio}},getLensBgStyle=function(evt){var mx,my,rx,ry,px,py,bgp;if(mx=evt.pageX?evt.pageX-el.left:evt.x,my=evt.pageY?evt.pageY-el.top:evt.y,$scope.positionAbsolute&&(my-=document.body.scrollTop,mx-=document.body.scrollLeft),!(mx<el.width&&my<el.height&&mx>0&&my>0))return void hideLens();showGlass(),rx=-1*Math.round(mx*$scope.zoomFactor-el.lensWidth/2),ry=-1*Math.round(my*$scope.zoomFactor-el.lensHeight/2),bgp=rx+"px "+ry+"px",px=mx-el.lensWidth/2,py=my-el.lensHeight/2;var bgSize=el.width*$scope.zoomFactor+"px "+el.height*$scope.zoomFactor+"px";return{left:px+"px",top:py+"px",backgroundPosition:bgp,backgroundSize:bgSize}};$scope.magnify=function(evt){var img;return nWidth||nHeight?getLensBgStyle(evt):void(isImageLoading||(img=new Image,img.onload=function(){nWidth=img.width,nHeight=img.height,isImageLoading=!1},img.src=$scope.imageSrc,isImageLoading=!0))},$scope.getOffset=function(el){var offsetLeft=0,offsetTop=0;if(el)for(isNaN(el.offsetLeft)||(offsetLeft+=el.offsetLeft,offsetTop+=el.offsetTop);el.offsetParent;)el=el.offsetParent,offsetTop+=el.offsetTop,offsetLeft+=el.offsetLeft;return{left:offsetLeft,top:offsetTop}},$scope.getLensStyle=function(){return{background:"url("+$scope.imageSrc+") no-repeat",width:$scope.lensWidth?$scope.lensWidth+"px":"",height:$scope.lensHeight?$scope.lensHeight+"px":""}}}}}}]);